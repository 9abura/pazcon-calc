<script>
  const baseTime = [18.0, 23.0, 30.0, 39.0, 51.0, 66.0, 88.0, 115.0, 150.0, 197.0, 260.0];
  const riskaReduction = [3,4.5,6,9,12,18.75,24,26,28];
  const powerList = [4,6,8,12,15,20,25,33,45,60,80];
  const eventPoints = [5,10,15,22,30,40,55,70,85,110,120];

  const baseCost = {
    infantry: [[3624,562,0,0],[5431,1312,0,0],[7496,2437,0,0],[10387,3937,0,0],[13518,5062,1125,0],[18225,7875,1575,0],[23400,10875,2250,0],[31200,15750,3150,0],[42112,22500,4500,0],[55800,31500,6300,630],[88500,47250,9450,945]],
    cavalry:  [[3624,562,0,0],[5431,1312,0,0],[7496,2437,0,0],[10387,3937,0,0],[13518,5062,1125,0],[18225,7875,1575,0],[23400,10875,2250,0],[31200,15750,3150,0],[42112,22500,4500,0],[55800,31500,6300,630],[88500,47250,9450,945]],
    archer:   [[3624,562,0,0],[5431,1312,0,0],[7496,2437,0,0],[10387,3937,0,0],[13518,5062,1125,0],[18225,7875,1575,0],[23400,10875,2250,0],[31200,15750,3150,0],[42112,22500,4500,0],[55800,31500,6300,630],[88500,47250,9450,945]],
    catapult: [[3624,562,0,0],[5431,1312,0,0],[7496,2437,0,0],[10387,3937,0,0],[13518,5062,1125,0],[18225,7875,1575,0],[23400,10875,2250,0],[31200,15750,3150,0],[42112,22500,4500,0],[68400,38250,8100,810],[99000,54000,10800,1080]]
  };

  function updateLabel() {
    const mode = document.getElementById("mode").value;
    const label = document.getElementById("dynamicLabel");
    if (mode === "count") label.textContent = "訓練したい人数:";
    if (mode === "power") label.textContent = "獲得したい戦力:";
    if (mode === "points") label.textContent = "獲得したいイベントポイント:";
  }

  function calculate() {
    const t = parseInt(document.getElementById("tLevel").value);
    const type = document.getElementById("type").value;
    const mode = document.getElementById("mode").value;
    const input = document.getElementById("inputValue");
    const buffInput = document.getElementById("speedBuff");

    let hasError = false;
    [input, buffInput].forEach(el => {
      if (!el.value) {
        el.classList.add("error");
        hasError = true;
      } else {
        el.classList.remove("error");
      }
    });
    if (hasError) return;

    const raw = parseFloat(input.value);
    const buff = parseFloat(buffInput.value);
    const rLv = document.getElementById("riskaLevel").value;
    const skill = document.getElementById("skill25").checked;
    const manual = parseFloat(document.getElementById("manualReduction").value);
    const unit = document.getElementById("timeUnit").value;

    let count;
    if (mode === "count") count = raw;
    if (mode === "power") count = raw / powerList[t - 1];
    if (mode === "points") count = raw / eventPoints[t - 1];

    const reduction = !isNaN(manual)
      ? manual
      : (rLv === "none" ? 0 : riskaReduction[parseInt(rLv)]) + (skill ? 25 : 0);

    const timeSec = count * baseTime[t - 1] * 100 / (100 + buff);
    const d = Math.floor(timeSec / 86400);
    const h = Math.floor((timeSec % 86400) / 3600);
    const m = Math.floor((timeSec % 3600) / 60);

    // 🚩 修正点！: コストを10人単位 → 1人単位 → 必要人数分で計算
    const cost = baseCost[type][t - 1];
    const final = cost.map(v => Math.round((v / 10) * count * (1 - reduction / 100)));

    let timeStr = "";
    if (unit === "day") timeStr = `${d}日 ${h}時間 ${m}分`;
    if (unit === "hour") timeStr = `${(timeSec / 3600).toFixed(2)} 時間`;
    if (unit === "minute") timeStr = `${(timeSec / 60).toFixed(0)} 分`;

    document.getElementById("output").innerHTML = `
      <b>訓練時間：</b>${timeStr}<br><br>
      <b>軽減後の訓練コスト（${reduction.toFixed(2)}% 減）</b><br>
      ・食料：${final[0].toLocaleString()}<br>
      ・木材：${final[1].toLocaleString()}<br>
      ・鉄：${final[2].toLocaleString()}<br>
      ・金貨：${final[3].toLocaleString()}
    `;
  }
</script>
